var inputType="string",firstRun=!0,addedCount=0,skippedCount=0,disenchantCount=0,offspecCount=0,missingCharacters=[],missingCharacterCount=0,errorCount=0,firstError=void 0;function parseCsv(e){if("true"!=$(e).prop("disabled")){disableForm(),$("#status-message").html("").hide(),errorCount=0,firstError=void 0,addedCount=0,skippedCount=0,disenchantCount=0,offspecCount=0,missingCharacterCount=0,missingCharacters=[];var t={delimiter:"",header:!0,dynamicTyping:!1,skipEmptyLines:!0,preview:0,step:void 0,encoding:"",worker:!1,comments:!1,complete:completeCsvImport,error:errorCsvImport,download:"remote"==inputType},o=$("#importTextarea").val();if("remote"==inputType?o=$("#url").val():"json"==inputType&&(o=$("#json").val()),firstRun?firstRun=!1:console.log("--------------------------------------------------"),"local"==inputType){if(!$("#files")[0].files.length)return alert("Please choose at least one file to parse."),enableForm(),0;$("#files").parse({config:t,before:function before(e,t){console.log("Parsing file...",e)},error:function error(e,t){console.log("ERROR:",e,t)},complete:function complete(){}})}else if("json"==inputType){if(!o)return alert("Please enter a valid JSON string to convert to CSV."),enableForm(),0;var a=Papa.unparse(o,t);console.log("Unparse complete"),a.length>maxUnparseLength&&(a=a.substr(0,maxUnparseLength),console.log("(Results truncated for brevity)")),console.log(a),setTimeout(function(){enableForm()},100)}else{if("remote"==inputType&&!o)return alert("Please enter the URL of a file to download and parse."),enableForm(),0;var n=Papa.parse(o,t);(t.worker||t.download)&&console.log("Running...")}}}function stepCsvImport(e,t){}function completeCsvImport(e){setTimeout(function(){},250);var t=0;if(e&&e.errors&&(e.errors&&(errorCount=e.errors.length,firstError=e.errors[0]),e.data&&e.data.length>0&&(t=e.data.length)),console.log("Parse complete"),console.log("    Rows:",t),console.log("    Errors:",errorCount),console.log("    First Error:",firstError),console.log("    Meta:",e.meta),console.log("    Results:",e),console.log("Loading data into form..."),e.data.length>0){prepareForm();for(var o=0,a=0;a<e.data.length;a++){var n=e.data[a],i=["de","disenchant"];null!=n.response&&i.includes(n.response.toLowerCase())?(console.log("Skipping row "+(a+1)+": Disenchant"),skippedCount++,disenchantCount++):(loadItemToForm(n,o),o++,addedCount++)}makeWowheadLinks(),$(".selectpicker").selectpicker("refresh")}var s="";firstError&&(s+='<li class="text-danger">Error: '.concat(firstError.message,"</li>")),addedCount&&(s+='<li class="text-success">'.concat(addedCount," item").concat(addedCount>1?"s":""," loaded into form</li>")),skippedCount&&(s+='<li class="text-warning">Skipped '.concat(skippedCount," item").concat(skippedCount>1?"s":""," ").concat(disenchantCount?"("+disenchantCount+" items disenchanted)":"","</li>")),offspecCount&&(s+='<li class="text-warning">'.concat(offspecCount," item").concat(offspecCount>1?"s":""," flagged as offspec</li>")),missingCharacterCount&&(missingCharacters=missingCharacters.join(", "),s+='<li class="text-danger">'.concat(missingCharacterCount," character").concat(missingCharacterCount>1?"s":""," not found: ").concat(missingCharacters,"</li>")),s&&$("#status-message").html("<ul>".concat(s,"</ul>")).show(),setTimeout(function(){enableForm()},100)}function errorCsvImport(e,t){console.log("ERROR:",e,t),$("#status-message").html("ERROR: "+e).show(),enableForm()}function loadItemToForm(e,t){var o=null,a=null,n=null,i=null,s=0,r="",c="",l=null,d=null,p=null;e.player?n=e.player.split("-")[0]:e.character&&(n=e.character),e.itemID?o=e.itemID:e.item_id&&(o=e.item_id),o&&18423==o&&(o=18422),o&&19003==o&&(o=18422),e.item?a=e.item:e.itemName?a=e.itemName:e.item_name&&(a=e.item_name),e.date?i=moment(e.date,"DD/MM/YY").format("YYYY-MM-DD"):e.dateTime?i=moment(e.dateTime).format("YYYY-MM-DD"):e.date_time&&(i=moment(e.date_time).format("YYYY-MM-DD")),e.publicNote?r=e.publicNote:e.public_note&&(r=e.public_note),r=r.substr(0,140),e.officerNote?c=e.officerNote:e.officer_note&&(c=e.officer_note),e.note&&(l=e.note),e.response&&(d=e.response),e.votes&&(p=e.votes),c=(c=(p?"Votes: "+p+" ":"")+(c?c+" ":"")+(d?'"'+d+'" ':"")+(l?'"'+l+'" ':"")).substr(0,140);var m=["os","offspec"];if(e.offspec&&1==e.offspec?s=1:(null==e.offspec||0!==e.offspec&&"false"!==e.offspec.toLowerCase()&&"no"!==e.offspec.toLowerCase())&&(e.note&&m.includes(e.note.toLowerCase())?s=1:e.response&&m.includes(e.response.toLowerCase())?s=1:e.publicNote&&m.includes(e.publicNote.toLowerCase())?s=1:e.officerNote&&m.includes(e.officerNote.toLowerCase())?s=1:e.officer_note&&m.includes(e.officer_note.toLowerCase())&&(s=1)),o){var u=$(".js-item-autocomplete[data-id="+t+"]").change();addTag(u,o,a)}if(n){var f=$("[name=item\\["+t+"\\]\\[character_id\\]]"),h=f.find('option[data-name="'+n+'"i]');h.val()?(h.prop("selected",!0).change(),f.parent().removeClass("form-danger")):-1==missingCharacters.indexOf(n)&&(console.log("Character not found for row "+(t+1)+": "+n),missingCharacterCount++,missingCharacters.push(n),f.parent().addClass("form-danger"))}return 1==s&&($("[name=item\\["+t+"\\]\\[is_offspec\\]]").prop("checked",!0).change(),console.log("Flagged as offspec for row "+(t+1)),offspecCount++),r&&$("[name=item\\["+t+"\\]\\[note\\]]").val(r).change(),c&&$("[name=item\\["+t+"\\]\\[officer_note\\]]").val(c).change(),i&&$("[name=item\\["+t+"\\]\\[received_at\\]]").val(i).change(),e}function prepareForm(){$("[name=toggle_notes]").prop("checked",!0).change(),$("[name=toggle_dates]").prop("checked",!0).change(),$("[name=date_default]").val("").change(),$("[name=raid_filter]").val("").change(),$("input[name^=item][name$=\\[note\\]]").val(""),$("input[name^=item][name$=\\[officer_note\\]]").val(""),$("select[name^=item][name$=\\[character_id\\]] option").prop("selected",!1),$("input[name^=item][name$=\\[is_offspec\\]]").prop("checked",!1),$(".js-item-autocomplete").val(""),$("input[name^=item][name$=\\[id\\]]").val(""),$("input[name^=item][name$=\\[label\\]]").val(""),$(".js-input-label").empty(),$(".input-item").hide(),$(".js-item-autocomplete").show(),$(".selectpicker").selectpicker("refresh")}function disableForm(){$("#loading-indicator").show(),$("#submitImport").prop("disabled",!0),$("#itemForm fieldset").prop("disabled",!0),$(".js-toggle-import").prop("disabled",!0)}function enableForm(){setTimeout(function(){$("#itemForm fieldset").prop("disabled",!1),$("#loading-indicator").hide(),$("#loaded-indicator").show(),setTimeout(function(){$("#submitImport").prop("disabled",!1),$(".js-toggle-import").prop("disabled",!1),$("#loaded-indicator").hide()},5e3)},1e3)}$(document).ready(function(){function showNext(e){if(""!=$(e).val()){$(e).show();var t=$(e).closest(".row").next(".js-hide-empty");t.show(),t.find("select[name^=item][name$=\\[character_id\\]]").addClass("selectpicker").selectpicker()}}$(".js-show-next").change(function(){showNext(this)}),$(".js-show-next").keyup(function(){showNext(this)}),$("select[name^=item][name$=\\[character_id\\]]:visible").addClass("selectpicker").selectpicker(),$("[name=raid_id]").on("change",function(){$(this).val()?$("#raidWarning").hide():$("#raidWarning").show()}).change(),$("#raid_filter").on("change",function(){var e=$(this).val();e?($(".js-character-option[data-raid-id!='"+e+"']").hide(),$(".js-character-option[data-raid-id='"+e+"']").show()):$(".js-character-option").show(),$(".selectpicker").selectpicker("refresh")}).change(),$("[name=toggle_notes]").on("change",function(){this.checked?$(".js-note").show():$(".js-note").hide()}).change(),$("[name=toggle_dates]").on("change",function(){this.checked?($(".js-date").show(),$("#default_datepicker").show()):($(".js-date").hide(),$("#default_datepicker").hide())}).change(),$("[name=date_default]").on("change",function(){$("[name*='received_at']").val($(this).val())}),$(".js-toggle-import").click(function(){$("#toggleImportArea").toggle(),$("#importArea").toggle()}),$("#tab-string").click(function(){$(".tab").removeClass("active"),$(this).addClass("active"),$(".input-area").hide(),$("#input-string").show(),$("#submit").text("Parse"),inputType="string"}),$("#tab-local").click(function(){$(".tab").removeClass("active"),$(this).addClass("active"),$(".input-area").hide(),$("#input-local").show(),$("#submit").text("Parse"),inputType="local"}),$("#tab-remote").click(function(){$(".tab").removeClass("active"),$(this).addClass("active"),$(".input-area").hide(),$("#input-remote").show(),$("#submit").text("Parse"),inputType="remote"}),$("#tab-unparse").click(function(){$(".tab").removeClass("active"),$(this).addClass("active"),$(".input-area").hide(),$("#input-unparse").show(),$("#submit").text("Unparse"),inputType="json"}),$("#submitImport").click(function(){parseCsv(this)})});
